#!/command/with-contenv bash

unit_bootstrap_filesystem() {
    if [ ! -d "${UNIT_STATE_PATH}" ]; then
        mkdir -p "${UNIT_STATE_PATH}"
    fi
    if [ "$(stat -c %U "${UNIT_STATE_PATH}")" != "${UNIT_USER}" ] ; then chown "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_STATE_PATH}" ; fi

    if [ ! -d "${UNIT_SOCKET_PATH}" ]; then
        mkdir -p "${UNIT_SOCKET_PATH}"
    fi
    if [ "$(stat -c %U "${UNIT_SOCKET_PATH}")" != "${UNIT_USER}" ] ; then silent chown "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_SOCKET_PATH}" ; fi

    if [ ! -d "${UNIT_MODULE_PATH}" ]; then
        mkdir -p "${UNIT_MODULE_PATH}"
    fi
    if [ "$(stat -c %U "${UNIT_MODULE_PATH}")" != "${UNIT_USER}" ] ; then silent chown "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_MODULE_PATH}" ; fi

    if [ "${UNIT_LOG_TYPE,,}" = "file" ]; then
        if [ ! -d "${UNIT_LOG_PATH}" ]; then
            mkdir -p "${UNIT_LOG_PATH}"
        fi

        if [ "$(stat -c %U "${UNIT_LOG_PATH}")" != "${UNIT_USER}" ] ; then chown "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_LOG_PATH}" ; fi
        touch "${UNIT_LOG_PATH}"/"${UNIT_LOG_FILE}"
        chown -R "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_LOG_PATH}"/"${UNIT_LOG_FILE}"
        create_logrotate unit "${UNIT_LOG_PATH}"/"${UNIT_LOG_FILE}" "${UNIT_USER}" "${UNIT_GROUP}"
    fi
}

unit_configure_instance() {
    :
}

unit_create_sample_html() {
    if [ ! -f "${UNIT_WEBROOT}/index.html" ]; then
        print_notice "Creating sample index.html"
        mkdir -p "${UNIT_WEBROOT}"
        cat <<EOF >"${UNIT_WEBROOT}"/index.html
<html>
<title>Default Page</title>
<h2>Container is working</h2>
Congratulations! Your ${IMAGE_NAME} image is working. You are seeing this because you don't have an index.html file in your ${UNIT_WEBROOT} directory.
</html>
EOF
        chown -R "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_WEBROOT}"
    fi
}

unit_post_init() {
    mkdir -p "${UNIT_WEBROOT}"
    if var_true "${UNIT_FORCE_RESET_PERMISSIONS}" ; then
        chown -R "${UNIT_USER}":"${UNIT_GROUP}" "${UNIT_WEBROOT}"
    fi
}
