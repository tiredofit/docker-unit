#!/command/with-contenv bash
set -x
source /assets/functions/00-container
source /assets/defaults/10-unit

if [ -z "${1}" ]; then
   echo "Tired of I.T! Unit Configuration Tool"
   echo "Usage: $(basename $0) (clear|edit|import|show) args"
   echo ""
   echo "Example: "
   echo ""
   echo "$(basename $0) clear - Clears configuration"
   echo "$(basename $0) edit - Opens an editor with all configuration and upon save reimports"
   echo "$(basename $0) import - Imports a file to configuration"
   echo "$(basename $0) show - Shows all running configuration"
   exit
fi

EDITOR=${EDITOR:-"nano"}

case "${UNIT_CONTROL_TYPE,,}" in
    ip)
        _unit_control="http://${_unit_control}/config"
    ;;
    socket)
        _unit_control="--unix-socket $(echo "${_unit_control}" | sed "s|unix:/||g") http://localhost/config"
    ;;
esac

case "${1,,}" in
    clear)
        curl -X DELETE ${_unit_control}
    ;;
    import )
        if [ -n "${2}" ]; then
            if [ -f "${2}" ]; then
                echo "** Importing ${2} to Unit Configuration"
                curl -X PUT --data-binary @${2} ${_unit_control}
            else
                echo "** Import file ${2} does not exist! Exiting.."
                exit 99
            fi
        else
            echo "** Nothing to import"
        fi
    ;;
    edit)
        now="$(TZ=$TIMEZONE date '+%Y%m%d-%H%M%S')"
        _tmp_unit_config=$(mktemp)
        curl -X GET ${_unit_control} > "${_tmp_unit_config}"
        cp "${_tmp_unit_config}" /tmp/"${now}"-unit.json
        echo "** Editing existing config. Backup copy saved at /tmp/${now}-unit.json"
        _tmp_unit_config_md5_orig="$(md5sum "${_tmp_unit_config}")"
        "${EDITOR}" "${_tmp_unit_config}"
        _tmp_unit_config_md5_edit="$(md5sum "${_tmp_unit_config}")"
        if [ "${_tmp_unit_config_md5_orig}" != "${_tmp_unit_config_md5_edit}" ]; then
            echo "** Importing to Unit Configuration"
            curl -X DELETE ${_unit_control}
            curl -X PUT --data-binary @${_tmp_unit_config} ${_unit_control}
        else
            echo "** Skipping Importing as file contents are the same"
        fi
        rm -rf "${_tmp_unit_config}"
    ;;
    show)
        curl -s -X GET ${_unit_control} | yq . -o json
    ;;
esac
